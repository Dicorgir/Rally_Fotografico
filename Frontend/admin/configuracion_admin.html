<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configuración Admin</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/login_style.css" />
    <link rel="stylesheet" href="../css/configuracion_admin_style.css">
    <link rel="stylesheet" href="../css/modo_oscuro.css">
    <link rel="stylesheet" href="../css/switch_style.css">
    <link rel="icon" type="image/png" href="../../img/logo_rallyFotografico.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  </head>
  <body>
    <!-- Sidebar igual que index.html -->
    <div class="sidebar">
      <div class="logo" title="Rally Fotográfico">
        <img src="../../img/logo_rallyFotografico.png" alt="Logo" style="width: 104px; height: 104px;" />
      </div>
      <!-- Switch de modo oscuro/claro -->
      <label class="switch" style="margin: 16px auto; display: flex; justify-content: center;">
        <input type="checkbox" id="theme-toggle">
        <span class="slider"></span>
      </label>
      <a href="../index.html">
        <div class="nav-item">
          <i class="fa-solid fa-house"></i>
          <span class="nav-text">Inicio</span>
        </div>
      </a>
      <!-- Opciones solo para admin -->
      <div class="nav-item active" id="logout-settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" color="currentColor"><path d="M2.256 15.632c.034-.323.268-.583.736-1.104l1.031-1.153c.252-.32.431-.875.431-1.375s-.179-1.056-.43-1.375L2.991 9.472c-.468-.52-.702-.781-.736-1.104s.14-.627.49-1.234l.494-.857c.373-.648.56-.972.878-1.1c.317-.13.676-.028 1.395.176l1.22.343c.459.106.94.046 1.358-.169l.337-.194a2 2 0 0 0 .788-.968l.334-.997c.22-.66.33-.99.591-1.18C10.403 2 10.75 2 11.444 2h1.115c.694 0 1.042 0 1.303.189s.371.519.59 1.179l.335.997a2 2 0 0 0 .788.968l.337.194c.418.215.9.275 1.358.17l1.22-.344c.719-.204 1.078-.306 1.395-.177c.318.13.505.453.878 1.101l.493.857c.35.607.525.91.491 1.234s-.268.583-.736 1.104l-1.031 1.153c-.252.319-.431.875-.431 1.375s.179 1.056.43 1.375l1.032 1.153c.468.52.702.781.736 1.104s-.14.627-.49 1.234l-.494.857c-.373.648-.56.972-.878 1.1c-.317.13-.676.028-1.395-.176l-1.22-.343a2 2 0 0 0-1.359.169l-.336.194c-.36.23-.636.57-.788.968l-.334.997c-.22.66-.33.99-.591 1.18c-.261.188-.609.188-1.303.188h-1.115c-.694 0-1.041 0-1.303-.189c-.261-.189-.371-.518-.59-1.178"/><path d="M2.737 18.78c1.08-1.08 4.752-4.716 5.112-5.136c.381-.444.072-1.044.256-2.904c.089-.9.282-1.574.836-2.076c.66-.624 1.2-.624 3.06-.666c1.62.042 1.812-.138 1.98.282c.12.3-.24.48-.672.96c-.96.96-1.524 1.44-1.578 1.74c-.39 1.32 1.146 2.1 1.986 1.26c.318-.318 1.788-1.8 1.932-1.92c.108-.096.367-.092.492.06c.108.106.12.12.108.6c-.01.444-.006 1.082-.004 1.74c.001.852-.044 1.8-.404 2.28c-.72 1.08-1.92 1.14-3 1.188c-1.02.06-1.86-.048-2.124.144c-.216.108-1.356 1.308-2.736 2.688l-2.46 2.46c-2.04 1.62-4.284-.9-2.784-2.7"/></g></svg>
        <span class="nav-text">Config</span>
      </div>
      <div class="nav-item" id="logout-gestion">
        <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 32 32"><path fill="currentColor" d="M15 20H9a3 3 0 0 0-3 3v2h2v-2a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2h2v-2a3 3 0 0 0-3-3m-3-1a4 4 0 1 0-4-4a4 4 0 0 0 4 4m0-6a2 2 0 1 1-2 2a2 2 0 0 1 2-2"/><path fill="currentColor" d="M28 19v9H4V8h12V6H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2v-9Z"/><path fill="currentColor" d="M20 19h6v2h-6zm2 4h4v2h-4zm10-13V8h-2.101a5 5 0 0 0-.732-1.753l1.49-1.49l-1.414-1.414l-1.49 1.49A5 5 0 0 0 26 4.101V2h-2v2.101a5 5 0 0 0-1.753.732l-1.49-1.49l-1.414 1.414l1.49 1.49A5 5 0 0 0 20.101 8H18v2h2.101a5 5 0 0 0 .732 1.753l-1.49 1.49l1.414 1.414l1.49-1.49a5 5 0 0 0 1.753.732V16h2v-2.101a5 5 0 0 0 1.753-.732l1.49 1.49l1.414-1.414l-1.49-1.49A5 5 0 0 0 29.899 10zm-7 2a3 3 0 1 1 3-3a3.003 3.003 0 0 1-3 3"/></svg>
        <span class="nav-text">Gestión <br> usuarios</span>
      </div>
      <div class="nav-item" id="logout-validation">
        <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" color="currentColor"><path d="M9.727 2c-3.26 0-4.892 0-6.024.798a4.1 4.1 0 0 0-.855.805C2 4.669 2 6.203 2 9.273v2.545c0 2.963 0 4.445.469 5.628c.754 1.903 2.348 3.403 4.37 4.113c1.257.441 2.83.441 5.98.441c1.798 0 2.698 0 3.416-.252c1.155-.406 2.066-1.263 2.497-2.35c.268-.676.268-1.523.268-3.216V15.5m-4-8s.5 0 1 1c0 0 1.588-2.5 3-3"/><path fill="currentColor" d="M22 7a5 5 0 1 1-10 0a5 5 0 0 1 10 0M2 12a3.333 3.333 0 0 0 3.333 3.333c.666 0 1.451-.116 2.098.057a1.67 1.67 0 0 1 1.179 1.18c.173.647.057 1.432.057 2.098A3.333 3.333 0 0 0 12 22"/></g></svg>
        <span class="nav-text">Validación <br> usuarios</span>
      </div>
      <div class="nav-item" id="logout-results">
        <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.5 18c0-1.414 0-2.121.44-2.56C4.378 15 5.085 15 6.5 15H7c.943 0 1.414 0 1.707.293S9 16.057 9 17v5H3.5zM15 19c0-.943 0-1.414.293-1.707S16.057 17 17 17h.5c1.414 0 2.121 0 2.56.44c.44.439.44 1.146.44 2.56v2H15zM2 22h20M9 16c0-1.414 0-2.121.44-2.56C9.878 13 10.585 13 12 13s2.121 0 2.56.44c.44.439.44 1.146.44 2.56v6H9zm3.691-13.422l.704 1.42a.87.87 0 0 0 .568.423l1.276.213c.816.137 1.008.734.42 1.323l-.992 1a.88.88 0 0 0-.208.73l.284 1.238c.224.98-.292 1.359-1.152.847l-1.196-.714a.86.86 0 0 0-.792 0l-1.196.714c-.856.512-1.376.129-1.152-.847l.284-1.238a.88.88 0 0 0-.208-.73l-.991-1c-.584-.589-.396-1.186.42-1.323l1.275-.213a.87.87 0 0 0 .564-.424l.704-1.42c.384-.77 1.008-.77 1.388 0" color="currentColor"/></svg>  
        <span class="nav-text">Resultados</span>
      </div>
      <div class="nav-divider"></div>


      <div class="nav-item" id="logout-btn" style="cursor:pointer;">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span class="nav-text">Cerrar<br>sesión</span>
      </div>
    </div>
    <!-- Formulario de configuración del rally -->
    <div class="main-content">
      <div class="form-container">
        <h2>Configuración de Rallies</h2>
        <table id="tabla-rallies">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Inicio recepción</th>
              <th>Fin recepción</th>
              <th>Límite fotos</th>
              <th>Inicio votación</th>
              <th>Fin votación</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- Aquí se llenarán los rallies -->
          </tbody>
        </table>
        <button id="nuevo-rally-btn" class="btn-nuevo-rally" style="margin-top:10px;">CREAR RALLY</button>
        <div id="mensaje-config"></div>
      </div>
    </div>
    <script>
/**
 * Asigna listeners a los botones del sidebar para navegación y cierre de sesión.
 * @event DOMContentLoaded
 */
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('logout-btn').addEventListener('click', function() {
        localStorage.removeItem('usuarioRol');
        localStorage.removeItem('usuarioNombre');
        window.location.href = '../index.html';
    });
    document.getElementById('logout-gestion').addEventListener('click', function() {
        window.location.href = 'gestion_usuario_admin.html';
    });
    document.getElementById('logout-validation').addEventListener('click', function() {
        window.location.href = 'validacion_fotos_admin.html';
    });
    document.getElementById('logout-results').addEventListener('click', function() {
        window.location.href = 'resultados_admin.html';
    });
});
</script>

<script>
/**
 * Carga, edita, elimina y crea rallies en la tabla de configuración.
 * Gestiona la interacción con el backend para la administración de rallies.
 * @event DOMContentLoaded
 */
document.addEventListener('DOMContentLoaded', async function() {
  // Cargar todos los rallies existentes y mostrarlos en la tabla
  const res = await fetch('../../Backend/get_rallies.php');
  const rallies = await res.json();
  const tbody = document.querySelector('#tabla-rallies tbody');
  tbody.innerHTML = '';
  rallies.forEach(rally => {
    // Por cada rally, crea una fila editable con sus datos
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${rally.nombre || ''}" data-campo="nombre"></td>
      <td><input type="date" value="${rally.fecha_inicio || ''}" data-campo="fecha_inicio"></td>
      <td><input type="date" value="${rally.fecha_fin || ''}" data-campo="fecha_fin"></td>
      <td><input type="number" min="1" value="${rally.max_fotos_por_participante || 1}" data-campo="max_fotos_por_participante"></td>
      <td><input type="date" value="${rally.fecha_inicio_votacion || ''}" data-campo="fecha_inicio_votacion"></td>
      <td><input type="date" value="${rally.fecha_fin_votacion || ''}" data-campo="fecha_fin_votacion"></td>
      <td>
        <button class="guardar-btn" data-id="${rally.id_rally}">Guardar</button>
        <button class="eliminar-btn" data-id="${rally.id_rally}" style="background:#e74c3c;margin-left:6px;">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Guardar cambios de un rally existente
  tbody.addEventListener('click', async function(e) {
    if (e.target.classList.contains('guardar-btn')) {
      const tr = e.target.closest('tr');
      const id_rally = e.target.dataset.id;
      const inputs = tr.querySelectorAll('input');
      const formData = new FormData();
      formData.append('id_rally', id_rally);
      inputs.forEach(input => {
        formData.append(input.dataset.campo, input.value);
      });
      // Envía los datos al backend para actualizar el rally
      const res = await fetch('../../Backend/update_rally.php', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      document.getElementById('mensaje-config').textContent = data.message || 'Configuración guardada';
      setTimeout(() => {
        document.getElementById('mensaje-config').textContent = '';
      }, 3000); // Limpia el mensaje tras 3 segundos
    }
    // Eliminar un rally
    if (e.target.classList.contains('eliminar-btn')) {
      if (confirm('¿Seguro que deseas eliminar este rally?')) {
        const id_rally = e.target.dataset.id;
        const res = await fetch('../../Backend/eliminar_rally.php', {
          method: 'POST',
          body: new URLSearchParams({ id_rally })
        });
        const data = await res.json();
        document.getElementById('mensaje-config').textContent = data.message || 'Rally eliminado';
        setTimeout(() => {
          document.getElementById('mensaje-config').textContent = '';
        }, 3000);
        if (data.success) {
          e.target.closest('tr').remove();
        }
      }
    }
  });

  // Añadir una nueva fila para crear un rally
  document.getElementById('nuevo-rally-btn').addEventListener('click', function() {
    const tbody = document.querySelector('#tabla-rallies tbody');
    // Evita que se creen múltiples formularios de creación
    if (tbody.querySelector('.nuevo-rally-row')) return;
    const tr = document.createElement('tr');
    tr.classList.add('nuevo-rally-row');
    tr.innerHTML = `
      <td><input type="text" placeholder="Nombre" data-campo="nombre"></td>
      <td><input type="date" data-campo="fecha_inicio"></td>
      <td><input type="date" data-campo="fecha_fin"></td>
      <td><input type="number" min="1" value="1" data-campo="max_fotos_por_participante"></td>
      <td><input type="date" data-campo="fecha_inicio_votacion"></td>
      <td><input type="date" data-campo="fecha_fin_votacion"></td>
      <td>
        <button class="guardar-btn crear-btn">Crear</button>
        <button class="guardar-btn cancelar-btn" style="background: #e74c3c;">Cancelar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Manejar la creación y cancelación de un nuevo rally
  document.querySelector('#tabla-rallies tbody').addEventListener('click', async function(e) {
    // Crear un nuevo rally
    if (e.target.classList.contains('crear-btn')) {
      const tr = e.target.closest('tr');
      const inputs = tr.querySelectorAll('input');
      const formData = new FormData();

      let nombre = '', fecha_inicio = '', fecha_fin = '', max_fotos = '', fecha_inicio_votacion = '', fecha_fin_votacion = '';
      inputs.forEach(input => {
        switch (input.dataset.campo) {
          case 'nombre': nombre = input.value.trim(); break;
          case 'fecha_inicio': fecha_inicio = input.value; break;
          case 'fecha_fin': fecha_fin = input.value; break;
          case 'max_fotos_por_participante': max_fotos = input.value; break;
          case 'fecha_inicio_votacion': fecha_inicio_votacion = input.value; break;
          case 'fecha_fin_votacion': fecha_fin_votacion = input.value; break;
        }
      });

      // Campos obligatorios
      if (!nombre || !fecha_inicio || !fecha_fin || !fecha_inicio_votacion || !fecha_fin_votacion) {
        document.getElementById('mensaje-config').textContent = 'Todos los campos son obligatorios';
        return;
      }
      // Máximo de fotos debe ser un número positivo
      if (!/^\d+$/.test(max_fotos) || parseInt(max_fotos) < 1) {
        document.getElementById('mensaje-config').textContent = 'El máximo de fotos debe ser un número positivo';
        return;
      }

      // Si todo está bien, continúa con el envío
      inputs.forEach(input => {
        formData.append(input.dataset.campo, input.value);
      });
      const res = await fetch('../../Backend/crear_rally.php', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      document.getElementById('mensaje-config').textContent = data.message || 'Rally creado';
      if (data.success) {
        tr.remove();
        location.reload(); // Recarga la página para mostrar el nuevo rally
      }
    }
    // Cancelar la creación de un rally
    if (e.target.classList.contains('cancelar-btn')) {
      e.target.closest('tr').remove();
    }
  });
});
</script>
<script>
/**
 * Controla el cambio entre modo oscuro y claro en la interfaz admin.
 * Guarda la preferencia en localStorage.
 * @event
 */
const themeToggle = document.getElementById('theme-toggle');
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
  document.body.classList.add('dark-mode');
  themeToggle.checked = true;
}
themeToggle.addEventListener('change', function() {
  if (this.checked) {
    document.body.classList.add('dark-mode');
    localStorage.setItem('theme', 'dark');
  } else {
    document.body.classList.remove('dark-mode');
    localStorage.setItem('theme', 'light');
  }
});
</script>
  </body>
</html>