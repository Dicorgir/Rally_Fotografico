<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mis Fotos</title>
    <link rel="stylesheet" href="../css/ver_fotos_style.css" />
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/modo_oscuro.css" />
    <link rel="stylesheet" href="../css/switch_style.css" />
    <link rel="icon" type="image/png" href="../../img/logo_rallyFotografico.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  </head>
  <body>
    <div class="sidebar">
      <!-- ...sidebar igual que en otras vistas... -->
      <div class="logo" title="Rally Fotográfico">
        <img src="../../img/logo_rallyFotografico.png" alt="Logo" style="width: 104px; height: 104px;" />
      </div>
      <!-- Switch de modo oscuro/claro -->
      <label class="switch" style="margin: 16px auto; display: flex; justify-content: center;">
        <input type="checkbox" id="theme-toggle">
        <span class="slider"></span>
      </label>
      <a href="../index.html">
        <div class="nav-item">
          <i class="fa-solid fa-house"></i>
          <span class="nav-text">Inicio</span>
        </div>
      </a>
      <div class="nav-item" id="logout-profile">
        <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24"><g fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"><path d="M16 9a4 4 0 1 1-8 0a4 4 0 0 1 8 0m-2 0a2 2 0 1 1-4 0a2 2 0 0 1 4 0"/><path d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11s11-4.925 11-11S18.075 1 12 1M3 12c0 2.09.713 4.014 1.908 5.542A8.99 8.99 0 0 1 12.065 14a8.98 8.98 0 0 1 7.092 3.458A9 9 0 1 0 3 12m9 9a8.96 8.96 0 0 1-5.672-2.012A6.99 6.99 0 0 1 12.065 16a6.99 6.99 0 0 1 5.689 2.92A8.96 8.96 0 0 1 12 21"/></g></svg>
        <span class="nav-text">Perfil</span>
      </div>
      <div class="nav-item" id="logout-add-photos">
        <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 48 48"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="4"><path d="M38 21v19a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V12a2 2 0 0 1 2-2h18.364"/><path fill="currentColor" d="M12 31.03L18 23l3 3l3.5-5.5L32 31.03z"/><path d="M34 10h8m-4.005-4.205v8"/></g></svg>
        <span class="nav-text">Subir <br> Fotos</span>
      </div>
      <div class="nav-item active" id="logout-view-photos">
        <svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" viewBox="0 0 8 8"><path fill="currentColor" d="m3 4l1-2l1 3H1l1-2m5 4V2h1v6H1V7m5-1V1H0v5"/></svg>
        <span class="nav-text">Ver <br>fotos</span>
      </div>
      <div class="nav-divider"></div>
      <div class="sidebar-profile-pic-container">
        <a href="perfil_participante.html">
          <img id="sidebar-profile-pic" class="sidebar-profile-pic" src="../../img/default_profile.png" alt="Foto de perfil" />
        </a>  
        </div>
      <div class="nav-item" id="logout-btn" style="cursor:pointer;">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span class="nav-text">Cerrar<br>sesión</span>
      </div>
    </div>
    <div class="main-content">
      <div class="fotos-container">
        <h2 class="title">Mis Fotografías</h2>
        <div id="fotos-list" class="fotos-list"></div>
        <div id="mensaje" class="mensaje"></div>
      </div>
    </div>
    <script>
/**
 * Gestiona la navegación del sidebar, la carga y visualización de fotos del usuario,
 * y la eliminación de fotos. También controla el modo oscuro.
 * @event DOMContentLoaded
 */
document.addEventListener('DOMContentLoaded', async function() {
  // Navegación sidebar
  document.getElementById('logout-btn').onclick = function() {
    localStorage.clear();
    window.location.href = '../index.html';
  };
  document.getElementById('logout-profile').onclick = function() {
    window.location.href = 'perfil_participante.html';
  };
  document.getElementById('logout-add-photos').onclick = function() {
    window.location.href = 'subir_fotos.html';
  };
  document.getElementById('logout-view-photos').onclick = function() {
    window.location.href = 'ver_fotos.html';
  };

  // Cargar fotos del usuario
  const email = localStorage.getItem('usuarioEmail');
  const fotosList = document.getElementById('fotos-list');
  const mensaje = document.getElementById('mensaje');
  fotosList.innerHTML = '';
  mensaje.textContent = '';

  // Mostrar foto de perfil y nombre en el sidebar
  const sidebarProfilePic = document.getElementById('sidebar-profile-pic');
  if (email) {
    fetch('http://localhost/Rally_Fotografico/Backend/get_perfil.php?email=' + encodeURIComponent(email))
      .then(res => res.json())
      .then(data => {
        if (data.foto_perfil) {
          sidebarProfilePic.src = '../../Backend/' + data.foto_perfil;
        } else {
          sidebarProfilePic.src = '../../img/default_profile.png';
        }
        sidebarProfilePic.title = data.nombre_completo || 'Usuario';
      });
  }

  if (!email) {
    mensaje.textContent = "No se ha encontrado el usuario.";
    return;
  }

  // Obtener fotos del usuario
  const res = await fetch('http://localhost/Rally_Fotografico/Backend/fotos_usuario.php?email=' + encodeURIComponent(email));
  const data = await res.json();

  if (!data.success) {
    mensaje.textContent = data.message || "No se pudieron cargar las fotos.";
    return;
  }

  if (data.fotos.length === 0) {
    mensaje.textContent = "No has subido ninguna foto.";
    return;
  }

  // Muestra cada foto y su información
  data.fotos.forEach(foto => {
    let motivo = '';
    if (!foto.eliminable) {
      const hoy = new Date();
      const fechaInicio = new Date(foto.fecha_inicio);
      const fechaFin = new Date(foto.fecha_fin);
      if (hoy < fechaInicio) {
        motivo = 'No se puede eliminar la foto porque el rally aún no ha comenzado.';
      } else if (hoy > fechaFin) {
        motivo = 'No se puede eliminar la foto porque el rally ya ha finalizado.';
      }
    }

    const fotoDiv = document.createElement('div');
    fotoDiv.className = 'foto-item' + (foto.eliminable ? '' : ' desactivada');
    fotoDiv.innerHTML = `
      <img src="data:image/jpeg;base64,${foto.imagen_base64}" alt="${foto.titulo}" class="foto-img"/>
      <div class="foto-info">
        <h3>${foto.titulo}</h3>
        <p>${foto.descripcion || ''}</p>
        <p class="rally-nombre"><strong>Rally:</strong> ${foto.nombre_rally || 'Desconocido'}</p>
        <span class="estado ${foto.estado}">Estado: ${foto.estado}</span>
        <button class="eliminar-btn" data-id="${foto.id_fotografia}" ${foto.eliminable ? '' : 'disabled'}><i class="fa-solid fa-trash"></i> Eliminar</button>
        ${!foto.eliminable ? `<div class="motivo-no-eliminar">${motivo}</div>` : ''}
      </div>
    `;
    fotosList.appendChild(fotoDiv);
  });

  /**
   * Permite eliminar una foto del usuario si es posible.
   * @event click
   */
  fotosList.addEventListener('click', async function(e) {
    if (e.target.closest('.eliminar-btn')) {
      const btn = e.target.closest('.eliminar-btn');
      const id = btn.getAttribute('data-id');
      if (confirm('¿Seguro que quieres eliminar esta foto?')) {
        const res = await fetch('http://localhost/Rally_Fotografico/Backend/eliminar_foto.php', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ id_fotografia: id, email })
        });
        const result = await res.json();
        if (result.success) {
          btn.closest('.foto-item').remove();
          mensaje.textContent = "Foto eliminada correctamente.";
          setTimeout(() => {
            mensaje.textContent = "";
          }, 3000);
        } else {
          mensaje.textContent = result.message || "No se pudo eliminar la foto.";
        }
      }
    }
  });
});

/**
 * Controla el cambio entre modo oscuro y claro.
 * Guarda la preferencia en localStorage.
 * @event
 */
const themeToggle = document.getElementById('theme-toggle');
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
  document.body.classList.add('dark-mode');
  themeToggle.checked = true;
}
themeToggle.addEventListener('change', function() {
  if (this.checked) {
    document.body.classList.add('dark-mode');
    localStorage.setItem('theme', 'dark');
  } else {
    document.body.classList.remove('dark-mode');
    localStorage.setItem('theme', 'light');
  }
});
</script>
  </body>
</html>