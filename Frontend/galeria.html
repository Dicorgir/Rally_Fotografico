<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galeria</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/galeria_style.css" />
    <link rel="stylesheet" href="css/button_style.css" />
    <link rel="stylesheet" href="css/modo_oscuro.css" />
    <link rel="stylesheet" href="css/switch_style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>

  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo" title="Rally Fotográfico">
        <img src="../img/logo_rallyFotografico.png" alt="Logo" style="width: 104px; height: 104px;" />
      </div>
      <!-- Switch de modo oscuro/claro -->
      <label class="switch" style="margin: 16px auto; display: flex; justify-content: center;">
        <input type="checkbox" id="theme-toggle">
        <span class="slider"></span>
      </label>

      <a href="index.html">
        <div class="nav-item">
          <i class="fa-solid fa-house"></i>
          <span class="nav-text">Home</span>
        </div>
      </a>

      <a href="registro.html">
        <div class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24">
            <path fill="currentColor" d="M15 14c-2.67 0-8 1.33-8 4v2h16v-2c0-2.67-5.33-4-8-4m-9-4V7H4v3H1v2h3v3h2v-3h3v-2m6 2a4 4 0 0 0 4-4a4 4 0 0 0-4-4a4 4 0 0 0-4 4a4 4 0 0 0 4 4"/>
          </svg>
          <span class="nav-text">Registro</span>
        </div>
      </a>

      <a href="login.html">
        <div class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24">
            <path fill="currentColor" fill-rule="evenodd" d="M3.5 9.568v4.864c0 2.294 0 3.44.722 4.153c.655.647 1.674.706 3.596.712l-.015-.105c-.115-.844-.115-1.916-.115-3.247v-.053c0-.403.331-.73.74-.73c.408 0 .739.327.739.73c0 1.396.001 2.37.101 3.105c.098.714.275 1.093.548 1.362s.656.445 1.379.54c.744.1 1.731.101 3.146.101h.985c1.415 0 2.401-.002 3.146-.1c.723-.096 1.106-.272 1.378-.541c.273-.27.451-.648.548-1.362c.1-.734.102-1.709.102-3.105V8.108c0-1.397-.002-2.37-.102-3.105c-.097-.714-.275-1.093-.547-1.362c-.273-.27-.656-.445-1.38-.54C17.728 3 16.742 3 15.327 3h-.985c-1.415 0-2.402.002-3.146.1c-.723.096-1.106.272-1.379.541c-.273.27-.45.648-.548 1.362c-.1.734-.101 1.708-.101 3.105c0 .403-.331.73-.74.73a.734.734 0 0 1-.739-.73v-.053c0-1.33 0-2.403.115-3.247l.015-.105c-1.922.006-2.94.065-3.596.712c-.722.713-.722 1.86-.722 4.153m9.885 5.38l2.464-2.432a.723.723 0 0 0 0-1.032l-2.464-2.432a.746.746 0 0 0-1.045 0a.723.723 0 0 0 0 1.032l1.202 1.186H6.457a.734.734 0 0 0-.74.73c0 .403.331.73.74.73h7.085l-1.202 1.186a.723.723 0 0 0 0 1.032a.746.746 0 0 0 1.045 0" clip-rule="evenodd"/>
          </svg>
          <span class="nav-text">Login</span>
        </div>
      </a>

      <div class="nav-item active">
        <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 36 36">
          <path fill="currentColor" d="M30.14 3a1 1 0 0 0-1-1h-22a1 1 0 0 0-1 1v1h24Z" class="clr-i-solid clr-i-solid-path-1"/><path fill="currentColor" d="M32.12 7a1 1 0 0 0-1-1h-26a1 1 0 0 0-1 1v1h28Z" class="clr-i-solid clr-i-solid-path-2"/><path fill="currentColor" d="M32.12 10H3.88A1.88 1.88 0 0 0 2 11.88v18.24A1.88 1.88 0 0 0 3.88 32h28.24A1.88 1.88 0 0 0 34 30.12V11.88A1.88 1.88 0 0 0 32.12 10M8.56 13.45a3 3 0 1 1-3 3a3 3 0 0 1 3-3M30 28H6l7.46-7.47a.71.71 0 0 1 1 0l3.68 3.68L23.21 19a.71.71 0 0 1 1 0L30 24.79Z" class="clr-i-solid clr-i-solid-path-3"/><path fill="none" d="M0 0h36v36H0z"/>
        </svg>
        <span class="nav-text">Galería</span>
      </div>

      <div class="nav-divider"></div>

      <div class="nav-item">
        <i class="fa-solid fa-gear"></i>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
      <div class="main-card">
        <h1 class="title">Galería</h1>
        <div class="selector-rally">
          <label for="rally-select"><strong>Selecciona un rally:</strong></label>
          <!-- Aquí tu select o controles -->
        </div>
        <div class="rallies-cards-container" id="rallies-cards"></div>
        <div id="galeria-fotos" class="galeria-fotos"></div>
        <div class="ranking-grafico-container">
          <div id="ranking" class="ranking"></div>
          <canvas id="grafico-votos" width="200" height="140"></canvas>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      let chartInstance = null; // Añade esto fuera del eventListener
      let idRallySeleccionado = null;

      document.addEventListener('DOMContentLoaded', async function() {
        const ralliesCards = document.getElementById('rallies-cards');
        const galeria = document.getElementById('galeria-fotos');
        const rankingDiv = document.getElementById('ranking');
        const grafico = document.getElementById('grafico-votos').getContext('2d');

        // 1. Cargar rallies y mostrarlos como cards
        const resRallies = await fetch('http://localhost/Rally_Fotografico/Backend/listar_rallies.php');
        const dataRallies = await resRallies.json();
        if (dataRallies.success) {
          ralliesCards.innerHTML = '';
          dataRallies.rallies.forEach(rally => {
            const card = document.createElement('div');
            card.className = 'rally-card';
            card.innerHTML = `
              <div class="rally-countdown" id="countdown-${rally.id_rally}"></div>
              <h3>${rally.nombre}</h3>
              <p><strong>Inicio:</strong> ${rally.fecha_inicio}</p>
              <p><strong>Fin:</strong> ${rally.fecha_fin}</p>
              <button class="ver-fotos-btn" data-id="${rally.id_rally}">Ver fotos</button>
            `;
            ralliesCards.appendChild(card);

            // Iniciar contador
            iniciarCountdown('countdown-' + rally.id_rally, rally.fecha_fin_votacion);
          });
        }

        // 2. Al hacer clic en una card, cargar las fotos de ese rally
        ralliesCards.addEventListener('click', async function(e) {
          if (e.target.classList.contains('ver-fotos-btn')) {
            idRallySeleccionado = e.target.getAttribute('data-id');
            galeria.innerHTML = '';
            rankingDiv.innerHTML = '';
            grafico.clearRect(0, 0, 400, 200);

            const res = await fetch(`http://localhost/Rally_Fotografico/Backend/galeria_fotos.php?id_rally=${idRallySeleccionado}`);
            const data = await res.json();
            if (!data.success) {
              galeria.textContent = "No se pudieron cargar las fotos.";
              return;
            }

            // Mostrar fotos
            galeria.innerHTML = '';
            data.fotos.forEach(foto => {
              const div = document.createElement('div');
              div.className = 'foto-galeria';
              div.innerHTML = `
                <img src="data:image/jpeg;base64,${foto.imagen_base64}" alt="${foto.titulo}" class="foto-galeria-img"/>
                <h4 class="foto-galeria-titulo">${foto.titulo}</h4>
                <p>${foto.descripcion || ''}</p>
                <button class="votar-btn" data-id="${foto.id_fotografia}">Votar</button>
                <button class="dislike-btn" data-id="${foto.id_fotografia}">Dislike</button>
                <span class="votos">Votos: ${foto.votos}</span>
                <button class="comentario-btn" data-id="${foto.id_fotografia}" title="Comentar">
                  <i class="fa-solid fa-cloud"></i> Comentar
                </button>
                <div class="comentario-form" style="display:none;">
                  <textarea class="comentario-text" rows="2" placeholder="Escribe tu comentario..."></textarea>
                  <button class="guardar-comentario-btn" data-id="${foto.id_fotografia}">Guardar</button>
                  <button class="ver-comentarios-btn" data-id="${foto.id_fotografia}" title="Ver comentarios">
                    <i class="fa-solid fa-comments"></i>
                  </button>
                </div>
              `;
              galeria.appendChild(div);
            });

            // Votación
            galeria.addEventListener('click', async function(e) {
              if (e.target.classList.contains('votar-btn')) {
                const id = e.target.getAttribute('data-id');
                const res = await fetch('http://localhost/Rally_Fotografico/Backend/votar_foto.php', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ id_fotografia: id })
                });
                const result = await res.json();
                alert(result.message || (result.success ? '¡Voto registrado!' : 'No se pudo votar.'));
                if (result.success) location.reload(); // Solo recarga si el voto fue exitoso
              }
              if (e.target.classList.contains('dislike-btn')) {
                const id = e.target.getAttribute('data-id');
                const res = await fetch('http://localhost/Rally_Fotografico/Backend/quitar_voto.php', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ id_fotografia: id })
                });
                const result = await res.json();
                alert(result.message || (result.success ? 'Voto quitado' : 'No se pudo quitar el voto'));
                if (result.success) location.reload(); // Solo recarga si el dislike fue exitoso
              }

              // Mostrar/ocultar formulario de comentario
              if (e.target.classList.contains('comentario-btn') || e.target.closest('.comentario-btn')) {
                const btn = e.target.closest('.comentario-btn');
                const form = btn.nextElementSibling;
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
              }

              // Guardar comentario
              if (e.target.classList.contains('guardar-comentario-btn')) {
                const id = e.target.getAttribute('data-id');
                const textarea = e.target.parentElement.querySelector('.comentario-text');
                const comentario = textarea.value.trim();
                if (!comentario) {
                  alert('El comentario no puede estar vacío.');
                  return;
                }
                const res = await fetch('http://localhost/Rally_Fotografico/Backend/guardar_comentario.php', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ id_fotografia: id, comentario })
                });
                const result = await res.json();
                alert(result.message || (result.success ? 'Comentario guardado' : 'No se pudo guardar el comentario'));
                if (result.success) {
                  textarea.value = '';
                  e.target.parentElement.style.display = 'none';
                }
              }

              // Ver comentarios
              if (e.target.classList.contains('ver-comentarios-btn') || e.target.closest('.ver-comentarios-btn')) {
                const btn = e.target.closest('.ver-comentarios-btn');
                const idFoto = btn.getAttribute('data-id');
                // Llama al backend para obtener los comentarios de esa foto
                const res = await fetch('http://localhost/Rally_Fotografico/Backend/obtener_comentarios.php?id_fotografia=' + idFoto);
                const data = await res.json();

                // Crea el fondo oscurecido
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = 0;
                overlay.style.left = 0;
                overlay.style.width = '100vw';
                overlay.style.height = '100vh';
                overlay.style.background = 'rgba(0,0,0,0.5)';
                overlay.style.zIndex = 9999;
                overlay.style.display = 'flex';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';

                // Crea la tarjeta blanca centrada
                const modal = document.createElement('div');
                modal.className = 'modal-comentarios'; // Añade esta línea
                modal.style.background = '#fff';
                modal.style.borderRadius = '16px';
                modal.style.boxShadow = '0 8px 32px rgba(60,60,120,0.16)';
                modal.style.padding = '2em 2em 1em 2em';
                modal.style.maxWidth = '500px';
                modal.style.width = '90vw';
                modal.style.maxHeight = '80vh';
                modal.style.overflowY = 'auto';
                modal.style.display = 'flex';
                modal.style.flexDirection = 'column';
                modal.style.alignItems = 'center';

                // Botón de cerrar
                const closeBtn = document.createElement('span');
                closeBtn.innerHTML = '&times;';
                closeBtn.style.fontSize = '2rem';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.alignSelf = 'flex-end';
                closeBtn.style.marginBottom = '0.5em';
                closeBtn.onclick = () => document.body.removeChild(overlay);
                modal.appendChild(closeBtn);

                // Título
                const titulo = document.createElement('h2');
                titulo.textContent = 'COMENTARIOS';
                titulo.style.color = '#6f42c1';
                modal.appendChild(titulo);

                // Lista de comentarios
                if (data.success && data.comentarios.length > 0) {
                  data.comentarios.forEach(com => {
                    const div = document.createElement('div');
                    div.style.background = '#ede7f6';
                    div.style.borderRadius = '8px';
                    div.style.margin = '0.5em 0';
                    div.style.padding = '1em';
                    div.style.width = '100%';
                    div.style.boxShadow = '0 2px 8px rgba(60,60,120,0.06)';
                    // Formatea la fecha y hora
                    const fecha = com.fecha_comentario 
                      ? new Date(com.fecha_comentario).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' }) 
                      : '';
                    div.innerHTML = `<div style="font-size:1.1em;">${com.comentario}</div>
                      <div style="color:#6f42c1;font-size:0.95em;margin-top:0.5em;">${fecha}</div>`;
                    modal.appendChild(div);
                  });
                } else {
                  const sinComentarios = document.createElement('div');
                  sinComentarios.textContent = 'No hay comentarios aún.';
                  sinComentarios.style.color = '#888';
                  modal.appendChild(sinComentarios);
                }

                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                overlay.addEventListener('click', function(e) {
                  if (e.target === overlay) {
                    document.body.removeChild(overlay);
                  }
                });
              }
            });

            // Ranking de fotos
            const ranking = [...data.fotos].sort((a, b) => b.votos - a.votos).slice(0, 5);
            rankingDiv.innerHTML = `
              <div class="top5-card">
                <h2>Top 5 Fotos</h2>
                <ol class="top5-list">
                  ${ranking.map((f, i) => `
                    <li>
                      <span class="top5-posicion">${i + 1}.</span>
                      <span class="top5-titulo">${f.titulo}</span>
                      <span class="top5-votos">${f.votos} votos</span>
                    </li>
                  `).join('')}
                </ol>
              </div>
            `;

            // Gráfico de votos
            if (chartInstance) {
              chartInstance.destroy();
            }
            chartInstance = new Chart(grafico, {
              type: 'doughnut', // o 'pie'
              data: {
                labels: data.fotos.map(f => f.titulo),
                datasets: [{
                  label: 'Votos',
                  data: data.fotos.map(f => f.votos),
                  backgroundColor: [
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(153, 102, 255, 0.5)',
                    'rgba(255, 159, 64, 0.5)'
                  ]
                }]
              },
              options: {
                plugins: {
                  legend: {
                    labels: {
                      color: "#fff" // Color blanco para la leyenda
                    }
                  }
                }
              }
            });
          }
        });
      });

      async function cargarFotosDelRallySeleccionado() {
        if (!idRallySeleccionado) return;
        // Simula el click en el botón de ver fotos del rally seleccionado
        const res = await fetch(`http://localhost/Rally_Fotografico/Backend/galeria_fotos.php?id_rally=${idRallySeleccionado}`);
        const data = await res.json();
        if (!data.success) {
          galeria.textContent = "No se pudieron cargar las fotos.";
          return;
        }
        // Mostrar fotos
        galeria.innerHTML = '';
        data.fotos.forEach(foto => {
          const div = document.createElement('div');
          div.className = 'foto-galeria';
          div.innerHTML = `
            <img src="data:image/jpeg;base64,${foto.imagen_base64}" alt="${foto.titulo}" class="foto-galeria-img"/>
            <h4 class="foto-galeria-titulo">${foto.titulo}</h4>
            <p>${foto.descripcion || ''}</p>
            <button class="votar-btn" data-id="${foto.id_fotografia}">Votar</button>
            <button class="dislike-btn" data-id="${foto.id_fotografia}">Dislike</button>
            <span class="votos">Votos: ${foto.votos}</span>
            <button class="comentario-btn" data-id="${foto.id_fotografia}" title="Comentar">
              <i class="fa-solid fa-cloud"></i> Comentar
            </button>
            <div class="comentario-form" style="display:none;">
              <textarea class="comentario-text" rows="2" placeholder="Escribe tu comentario..."></textarea>
              <button class="guardar-comentario-btn" data-id="${foto.id_fotografia}">Guardar</button>
              <button class="ver-comentarios-btn" data-id="${foto.id_fotografia}" title="Ver comentarios">
                <i class="fa-solid fa-comments"></i>
              </button>
            </div>
          `;
          galeria.appendChild(div);
        });

        // Ranking de fotos
        const ranking = [...data.fotos].sort((a, b) => b.votos - a.votos).slice(0, 5);
        rankingDiv.innerHTML = `
          <div class="top5-card">
            <h2>Top 5 Fotos</h2>
            <ol class="top5-list">
              ${ranking.map((f, i) => `
                <li>
                  <span class="top5-posicion">${i + 1}.</span>
                  <span class="top5-titulo">${f.titulo}</span>
                  <span class="top5-votos">${f.votos} votos</span>
                </li>
              `).join('')}
            </ol>
          </div>
        `;

        // Gráfico de votos
        if (chartInstance) {
          chartInstance.destroy();
        }
        chartInstance = new Chart(grafico, {
          type: 'doughnut', // o 'pie'
          data: {
            labels: data.fotos.map(f => f.titulo),
            datasets: [{
              label: 'Votos',
              data: data.fotos.map(f => f.votos),
              backgroundColor: [
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 99, 132, 0.5)',
                'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)',
                'rgba(153, 102, 255, 0.5)',
                'rgba(255, 159, 64, 0.5)'
              ]
            }]
          },
          options: {
            plugins: {
              legend: {
                labels: {
                  color: "#fff" // Color blanco para la leyenda
                }
              }
            }
          }
        });
      }

      function quitarVoto(id_fotografia) {
        fetch('Backend/quitar_voto.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id_fotografia })
        })
        .then(res => res.json())
        .then(data => {
          alert(data.message || (data.success ? 'Voto quitado' : 'No se pudo quitar el voto'));
          // Recarga la galería o actualiza los votos
          cargarFotosDelRallySeleccionado();
        });
      }

      function iniciarCountdown(elementId, fechaFin) {
        function actualizar() {
          const countdownElem = document.getElementById(elementId);
          if (!countdownElem) return;
          const fin = new Date(fechaFin.replace(' ', 'T'));
          const ahora = new Date();
          const diff = fin - ahora;
          if (diff <= 0) {
            countdownElem.textContent = "00:00:00:00";
            countdownElem.style.color = "#ff4f4f";
            // Elimina aviso si existe
            const aviso = countdownElem.nextElementSibling;
            if (aviso && aviso.classList.contains('aviso-rapido')) aviso.remove();
            // Desactiva los botones de votación y comentarios
            desactivarBotonesVotacion();
            return;
          }
          const dias = String(Math.floor(diff / (1000 * 60 * 60 * 24))).padStart(2, '0');
          const horas = String(Math.floor((diff / (1000 * 60 * 60)) % 24)).padStart(2, '0');
          const minutos = String(Math.floor((diff / (1000 * 60)) % 60)).padStart(2, '0');
          const segundos = String(Math.floor((diff / 1000) % 60)).padStart(2, '0');
          countdownElem.textContent = `${dias}:${horas}:${minutos}:${segundos}`;
          // Cambia a rojo si quedan menos de 2 días y muestra aviso
          if (parseInt(dias) < 2) {
            countdownElem.style.color = "#ff4f4f";
            // Mostrar aviso si no existe
            if (!countdownElem.nextElementSibling || !countdownElem.nextElementSibling.classList.contains('aviso-rapido')) {
              const aviso = document.createElement('div');
              aviso.className = 'aviso-rapido';
                aviso.textContent = "¡Quedan menos de 2 días para votar!";
                aviso.style.color = "#ff4f4f";
                aviso.style.fontSize = "1.4rem";
                aviso.style.fontWeight = "bold";
                aviso.style.marginTop = "0.3em";
                aviso.style.display = "block";
                aviso.style.marginBottom = "1em";
              countdownElem.parentNode.insertBefore(aviso, countdownElem.nextSibling);
            }
          } else {
            countdownElem.style.color = "#6f42c1";
            // Elimina aviso si existe
            const aviso = countdownElem.nextElementSibling;
            if (aviso && aviso.classList.contains('aviso-rapido')) aviso.remove();
          }
          setTimeout(actualizar, 1000);
        }
        actualizar();
      }

      function desactivarBotonesVotacion() {
        document.querySelectorAll('.votar-btn, .dislike-btn, .comentario-btn, .guardar-comentario-btn').forEach(btn => {
          btn.disabled = true;
          btn.classList.add('btn-desactivado');
        });
      }
    </script>
    <script>
      const themeToggle = document.getElementById('theme-toggle');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.body.classList.add('dark-mode');
        themeToggle.checked = true;
      }
      themeToggle.addEventListener('change', function() {
        if (this.checked) {
          document.body.classList.add('dark-mode');
          localStorage.setItem('theme', 'dark');
        } else {
          document.body.classList.remove('dark-mode');
          localStorage.setItem('theme', 'light');
        }
      });
      </script>
  </body>
</html>