<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galeria</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/carrusel_style.css" />
    <link rel="stylesheet" href="css/button_style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>

  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo" title="Rally Fotográfico">
        <img src="../img/logo_rallyFotografico.png" alt="Logo" style="width: 104px; height: 104px;" />
      </div>

      <a href="index.html">
        <div class="nav-item">
          <i class="fa-solid fa-house"></i>
          <span class="nav-text">Home</span>
        </div>
      </a>

      <a href="registro.html">
        <div class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24">
            <path fill="currentColor" d="M15 14c-2.67 0-8 1.33-8 4v2h16v-2c0-2.67-5.33-4-8-4m-9-4V7H4v3H1v2h3v3h2v-3h3v-2m6 2a4 4 0 0 0 4-4a4 4 0 0 0-4-4a4 4 0 0 0-4 4a4 4 0 0 0 4 4"/>
          </svg>
          <span class="nav-text">Registro</span>
        </div>
      </a>

      <a href="login.html">
        <div class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24">
            <path fill="currentColor" fill-rule="evenodd" d="M3.5 9.568v4.864c0 2.294 0 3.44.722 4.153c.655.647 1.674.706 3.596.712l-.015-.105c-.115-.844-.115-1.916-.115-3.247v-.053c0-.403.331-.73.74-.73c.408 0 .739.327.739.73c0 1.396.001 2.37.101 3.105c.098.714.275 1.093.548 1.362s.656.445 1.379.54c.744.1 1.731.101 3.146.101h.985c1.415 0 2.401-.002 3.146-.1c.723-.096 1.106-.272 1.378-.541c.273-.27.451-.648.548-1.362c.1-.734.102-1.709.102-3.105V8.108c0-1.397-.002-2.37-.102-3.105c-.097-.714-.275-1.093-.547-1.362c-.273-.27-.656-.445-1.38-.54C17.728 3 16.742 3 15.327 3h-.985c-1.415 0-2.402.002-3.146.1c-.723.096-1.106.272-1.379.541c-.273.27-.45.648-.548 1.362c-.1.734-.101 1.708-.101 3.105c0 .403-.331.73-.74.73a.734.734 0 0 1-.739-.73v-.053c0-1.33 0-2.403.115-3.247l.015-.105c-1.922.006-2.94.065-3.596.712c-.722.713-.722 1.86-.722 4.153m9.885 5.38l2.464-2.432a.723.723 0 0 0 0-1.032l-2.464-2.432a.746.746 0 0 0-1.045 0a.723.723 0 0 0 0 1.032l1.202 1.186H6.457a.734.734 0 0 0-.74.73c0 .403.331.73.74.73h7.085l-1.202 1.186a.723.723 0 0 0 0 1.032a.746.746 0 0 0 1.045 0" clip-rule="evenodd"/>
          </svg>
          <span class="nav-text">Login</span>
        </div>
      </a>

      <div class="nav-item active">
        <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 36 36">
          <path fill="currentColor" d="M30.14 3a1 1 0 0 0-1-1h-22a1 1 0 0 0-1 1v1h24Z" class="clr-i-solid clr-i-solid-path-1"/><path fill="currentColor" d="M32.12 7a1 1 0 0 0-1-1h-26a1 1 0 0 0-1 1v1h28Z" class="clr-i-solid clr-i-solid-path-2"/><path fill="currentColor" d="M32.12 10H3.88A1.88 1.88 0 0 0 2 11.88v18.24A1.88 1.88 0 0 0 3.88 32h28.24A1.88 1.88 0 0 0 34 30.12V11.88A1.88 1.88 0 0 0 32.12 10M8.56 13.45a3 3 0 1 1-3 3a3 3 0 0 1 3-3M30 28H6l7.46-7.47a.71.71 0 0 1 1 0l3.68 3.68L23.21 19a.71.71 0 0 1 1 0L30 24.79Z" class="clr-i-solid clr-i-solid-path-3"/><path fill="none" d="M0 0h36v36H0z"/>
        </svg>
        <span class="nav-text">Galería</span>
      </div>

      <div class="nav-divider"></div>

      <div class="nav-item">
        <i class="fa-solid fa-gear"></i>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
      <h1>Galería</h1>
      <p>Bienvenido a la galería</p>
      <div id="galeria-fotos" class="galeria-fotos"></div>
      <div id="ranking" class="ranking"></div>
      <canvas id="grafico-votos" width="400" height="200"></canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async function() {
        const galeria = document.getElementById('galeria-fotos');
        const rankingDiv = document.getElementById('ranking');
        const grafico = document.getElementById('grafico-votos').getContext('2d');

        // 1. Obtener fotos del backend
        const res = await fetch('http://localhost/Rally_Fotografico/Backend/galeria_fotos.php');
        const data = await res.json();
        if (!data.success) {
          galeria.textContent = "No se pudieron cargar las fotos.";
          return;
        }

        // 2. Mostrar fotos con botón de votar
        galeria.innerHTML = '';
        data.fotos.forEach(foto => {
          const div = document.createElement('div');
          div.className = 'foto-galeria';
          div.innerHTML = `
            <img src="data:image/jpeg;base64,${foto.imagen_base64}" alt="${foto.titulo}" />
            <h3>${foto.titulo}</h3>
            <p>${foto.descripcion || ''}</p>
            <button class="votar-btn" data-id="${foto.id_fotografia}">Votar</button>
            <span class="votos">Votos: ${foto.votos}</span>
          `;
          galeria.appendChild(div);
        });

        // 3. Votación con límite por IP
        galeria.addEventListener('click', async function(e) {
          if (e.target.classList.contains('votar-btn')) {
            const id = e.target.getAttribute('data-id');
            const res = await fetch('http://localhost/Rally_Fotografico/Backend/votar_foto.php', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ id_fotografia: id })
            });
            const result = await res.json();
            if (result.success) {
              alert('¡Voto registrado!');
              location.reload();
            } else {
              alert(result.message || 'No se pudo votar.');
            }
          }
        });

        // 4. Ranking de fotos
        const ranking = [...data.fotos].sort((a, b) => b.votos - a.votos).slice(0, 5);
        rankingDiv.innerHTML = '<h2>Top 5 Fotos</h2><ol>' +
          ranking.map(f => `<li>${f.titulo} - ${f.votos} votos</li>`).join('') +
          '</ol>';

        // 5. Gráfico de votos
        new Chart(grafico, {
          type: 'bar',
          data: {
            labels: data.fotos.map(f => f.titulo),
            datasets: [{
              label: 'Votos',
              data: data.fotos.map(f => f.votos),
              backgroundColor: 'rgba(54, 162, 235, 0.5)'
            }]
          }
        });
      });
    </script>
  </body>
</html>